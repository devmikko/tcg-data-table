<link rel="import" href="../polymer/polymer.html">

<!--
Datatable element that can handle data client side and server side

##### Example

    <tcg-data-table></tcg-data-table>

@element tcg-data-table
@blurb Datatable element that can handle data client side and server side
@status alpha
@homepage https://github.com/the-control-group/tcg-data-table
-->

<polymer-element name="tcg-data-table">
  <template>
    <!--<link rel="stylesheet" href="datatables/media/css/jquery.dataTables.css"> -->
    <link rel="stylesheet" href="./tcg-data-table.css"> 
    <table id="table" class="display stripe" cellspacing="0" width="100%"></table>
  </template>
  <script src="../datatables/media/js/jquery.js"></script>
  <script src="../datatables/media/js/jquery.dataTables.min.js"></script>
  <script src="assets/js/dataTables.tableTools.js"></script>
  <script>
    Polymer({
      publish: {
        name: 'Name of Table',
        data: [],
        columns: [],
        perPage: 10,
        paginationResults: 9,
        page:'',
        search:'',
        sort: '',
        total: 0,
        server: false
      },

      observe: {
        'data columns': 'setup'
      },

      domReady: function(){
        
        this.setup();
        
      },

      ready: function(){
        if(this.page || this.search){
          this.server = true;
        }
      },

      exportCsv: function(){
        var value = $('body /deep/ table').children().map(function(i, group){
          return $(group).children().toArray().map(function(tr){
            return '"' + $(tr).children().toArray().map(function(td){
              return $(td).text().trim().replace(/"/g, '""');
            }).join('","') + '"';
          })
        }).toArray().join('\n');        

        //Download the file
        this.download('data:application/xls;charset=utf-8,' + encodeURIComponent(value), 'table_data.xls');

      },

      download: function(uri, filename){
        var link = document.createElement('a');
        if (typeof link.download !== 'string')
          return location.replace();

        document.body.appendChild(link); //Firefox requires the link to be in the body
        link.download = filename;
        link.href = uri;
        link.click();
        document.body.removeChild(link); //remove the link when done
      },

      setup: function(){

        if(this.oTable){
          this.oTable.destroy();
        }

        if(this.data){
          console.log('run again');
          console.log(this.data);
          console.log('run again 2');
          this.oTable = $(this.$.table).DataTable({
             //serverSide: true,
             //ajax: {
              //url: this.url
              // url: "https://api.dribbble.com/v1/user?access_token=c943330af3cc33a69f31084e5898f0ca624015bd5cca526214ff83a859902f62"
              // }
              "dom": 'T<"toolbar">lfrtip',
              "data": this.data,
              "columns": this.columns,

              "bLengthChange": false,
              "iDisplayLength": this.perPage,
              "oLanguage": { "sSearch": "" }
              
              });

          if(this.server){
            this.addCustomPagination();
            //this.addCustomSearch();
          }

          this.async(function(){
            $('body /deep/ .toolbar').html(this.name);
            console.log($("body /deep/ .DTTT_button_csv" ).has('button').length);
            if($("body /deep/ .DTTT_button_csv" ).has('button').length < 1){
              $("body /deep/ .DTTT_button_csv").append("<label id=\"export_label\">Export:</label>");
              $("body /deep/ .DTTT_button_csv").append("<button id=\"export_pdf\"></button>");
              $("body /deep/ .DTTT_button_csv").append("<button id=\"export_excel\"></button>");
              };

            self = this;
            $("body /deep/ #export_excel").click(function(){
              self.exportCsv();
            });
            $('body /deep/ input[type="search"]').attr('placeholder','Search');  

            console.log(this.data);
            if(self.server){
              $("body /deep/ .sorting_desc, body /deep/ .sorting_asc").unbind()
                  .bind("th", function(e) { // Bind our desired behavior
                      // reload table data
                      self.search = this.value;
                      //reload

                  });

                  $("body /deep/ .sorting_desc, body /deep/ .sorting_desc").unbind()
                  .bind("th", function(e) { // Bind our desired behavior
                      // reload table data
                      self.search = this.value;
                      //reload

                  });


              $("body /deep/ .dataTables_filter input").unbind() // Unbind previous default bindings
                  .bind("input", function(e) { // Bind our desired behavior
                      // reload table data
                      self.search = this.value;
                      //reload

                  });

                };
          });
      }
    },

    addCustomPagination: function(){
        
        this.async(function(){
          if(this.page){

            var disabled = '';

            if(this.page == 1){
              disabled = " disabled";
            }
            var prevTemplate = '<a class="paginate_button previous' + disabled + '" id="table_previous">Previous</a>';

           
            var pages = '';
            if(this.total < this.perPage){ this.perPage = this.total; this.paginationResults = 1; }
            var pagination_mid = parseInt(this.page - Math.floor(this.paginationResults/2));
            if(pagination_mid < 1){ pagination_mid = 1; }



            for(var i=pagination_mid; i < pagination_mid+this.paginationResults; i++){
              if(i*this.perPage > this.total){ break; }
              var current = '';
              if(i == this.page){ current = ' current'; }
              pages = pages + '<span><a class="paginate_button pageinate_page' + current + '" aria-controls="table" data-page="' + i + '" tabindex="0">' + i + '</a></span>';
            }

            var nextTemplate = '<a class="paginate_button next" id="table_next">Next</a>';
            var template = prevTemplate + pages + nextTemplate;

            // Add the New Pagination template
            $('body /deep/ .dataTables_paginate').html(template);

            // Perform the Link functionality to set page accordingly
            this.async(function(){
              var self = this;
              $('body /deep/ #table_next').not('.disabled').click(function(){
                self.page += 1;
              });
              $('body /deep/ #table_previous').not('.disabled').click(function(){
                self.page -= 1;
              });
              $('body /deep/ .pageinate_page').click(function(){
                self.page = $(this).data('page');
              });
            });
          }
        });
    },

  });


  </script>
</polymer-element>

